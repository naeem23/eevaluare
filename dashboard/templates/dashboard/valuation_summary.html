{% extends "base.html" %}

{% block title %} Add Valuation {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
    {% load static %}
    <!-- dropzone file upload -->
    <script src="{% static 'dashboard/js/dropzone.js' %}"></script>
    <link rel="stylesheet" href="{% static 'dashboard/css/dropzone.css' %}">
    
    <style>
        .msg {
            padding-left: 10px;
        }
        .fotografii {
            padding: 0 1.25rem 1rem 1.25rem;
            border-bottom: 1px solid rgba(181,181,181,.1);
        }
        .fotografii-title{
            margin: 0;
            color: #fff;
            font-size: 18px;
            font-weight: 400;
            line-height: 1.6;
        }
        .fotografii-body {
            padding: 1.25rem;
        }
        .btn-muted {
            background: rgba(169,175,187,.82);
            color: #fff;
        }

        .show-approach {
            display: block!important;
        }
        .market, .income {
            display: none;
        }
        .warning {
            font-size: 16px;
            border: 2px solid red;
            padding: 5px 20px;
            color: red;
        }
    </style>
{% endblock stylesheets %}

{% block content %}

    <div class="content">
        <div class="page-inner">
            <div class="page-header">
                <h4 class="page-title">Add Valuation</h4>
                <ul class="breadcrumbs">
                    <li class="nav-home">
                        <a href="#">
                            <i class="flaticon-home"></i>
                        </a>
                    </li>
                    <li class="separator">
                        <i class="flaticon-right-arrow"></i>
                    </li>
                    <li class="nav-item">
                        <a href="">Valuation Form</a>
                    </li>
                </ul>
            </div>


            {% if warning %}
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Rezumatul Evaluarii</div>
                </div>
                <div class="card-body">
                    <p class="warning mb-3">Please set <a href="{% url 'dashboard:add_valuation' %}?next=attrs&id={{valuation_id}}" class="text-default">property attributes</a> first.</p>
                </div>
                <div class="card-action">
                    <a class="btn btn-muted mr-2" href="{% url 'dashboard:add_valuation' %}?next=attrs&id={{valuation_id}}">CREATE ATTRIBUTES</a>
                    <a class="btn btn-success" href="{% url 'dashboard:details' id=valuation_id %}">SAVE & CONTINUE</a>
                </div>
            </div>
            {% else %}
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Rezumatul Evaluarii</div>
                </div>

                <div class="card-body">
                    {% if msg %}
                    <p class="msg mb-3">{{ msg }}</p>
                    {% endif %}
                    <form method="POST" id="summary-value">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="id_purpose">Scopul Evaluarii <span class="required-label">*</span></label>
                                    <select class="form-control" id="id_purpose" name="purpose">
                                        <option value="purpose1" {% if summary.purpose == 'purpose1' %}selected{% endif %}>Purpose 1</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="id_fer">Curs valutar <span class="required-label">*</span></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="fer" id="id_fer" value="{{ fer }}">
                                        <div class="input-group-append">
                                            <span class="input-group-text">RON</span>
                                        </div>
                                    </div>
                                    <small class="form-text text-muted">Forex exchange rate of last day</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="id_approach">Evaluare abordare <span class="required-label">*</span></label>
                                    <select class="form-control" id="id_approach" name="approach">
                                        <option value='market' {% if summary.approach == 'market' %}selected{% endif %}>Abordarea prin piata</option>
                                        <option value='income' {% if summary.approach == 'income' %}selected{% endif %}>Abordarea prin venit</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="market {% if summary.approach == 'market' or not summary %}show-approach{% endif %}">
                            <p class="mt-4 ml-2 text-white" style="font-size: 18px;">Abordarea prin piata</p>
                            <div class="row mt-3">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="id_amav">Apartament</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" name="amav" id="id_amav" placeholder="e.g. 187000" value="{{summary.amav}}">
                                            <div class="input-group-append">
                                                <span class="input-group-text">EUR</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {% for a in valueattr %}
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>{{ a.attr_id.name }} nr. {{a.attr_value}}</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" name="mav_{{ a.id }}" placeholder="e.g 10000" {% if summary %}value="{{a.mav}}"{% endif %}>
                                            <div class="input-group-append">
                                                <span class="input-group-text">EUR</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="income {% if summary.approach == 'income' %}show-approach{% endif %}">
                            <p class="mt-4 ml-2 text-white" style="font-size: 18px;">Abordarea prin venit</p>
                            <div class="row mt-3">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="id_aiav">Apartament</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" name="aiav" id="id_aiav" placeholder="e.g. 162000" value="{{summary.aiav}}">
                                            <div class="input-group-append">
                                                <span class="input-group-text">EUR</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {% for a in valueattr %}
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>{{ a.attr_id.name }} nr. {{a.attr_value}}</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" name="iav_{{ a.id }}" placeholder="e.g. 10000" {% if summary %}value="{{a.iav}}"{% endif %}>
                                            <div class="input-group-append">
                                                <span class="input-group-text">EUR</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </form>
                </div>

                <div class="fotografii">
                    <div class="fotografii-title">Fotografii</div>
                </div>
                
                <div class="fotografii-body">
                    <div class="row">
                        <div class="col-md-12">
                            <form action="{% url 'dashboard:save_cover_photos' %}" class="dropzone dz-clickable" id="stepFourDropzone">
                                {% csrf_token %}
                                <input type="hidden" name="cover_vid" id="cover_vid" value="{{ valuation_id }}">
                                <input type="hidden" name="order" id="image-order" value="">
                                <input type="hidden" name="refer_to" value="summary">
                                <div class="dz-message" data-dz-message="">
                                    <div class="icon">
                                        <i class="flaticon-file"></i>
                                    </div>
                                    <h4 class="message">Drag and Drop files here</h4>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="card-action">
                    {% if summary %}
                    <button class="btn btn-success step-two-next" id="update">UPDATE</button>
                    {% else %}
                    <button class="btn btn-success step-two-next" id="finish">FINISH</button>
                    {% endif %}
                </div>
            </div>
            {% endif %} <!-- warning if condition ends here-->
        </div>
    </div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
    <script type="text/javascript">
        // upload photos
        var order = 1;
        $("#stepFourDropzone").click(function () {
            $('#image-order').val(order);
            order++;
        })
        Dropzone.options.stepFourDropzone = {
            maxFiles: 4,
            init: function() {
                this.on("maxfilesexceeded", function(file){
                    alert("No more files please!");
                });
            }
        };
        // upload photos

        // submit form
        $("#finish").click(function () {
            $("#summary-value").submit();
        });
        $("#update").click(function () {
            $("#summary-value").submit();
        });
        // submit form

        // select approach and change data field
        $("#id_approach").change(function() {
            var value = $(this).children("option:selected").val();
            if (value == 'market') {
                $('.market').css('display', 'block');
            } else if (value == 'income') {
                $('.market').css('display', 'none');
                $('.income').css('display', 'block');
            }
        });
        // select approach and change data field

        // forex exchange rate
        // $(document).ready(function () {
        //     fetch('https://free.currconv.com/api/v7/convert?q=EUR_RON&compact=ultra&apiKey=839fc422eaee98caca01')
        //     .then(response => response.json())
        //     .then((json) => {
        //         $("#id_fer").val(json.EUR_RON.toFixed(2))
        //     })
        //     .catch(function (error) {
        //       return error;
        //     })
        // });
    </script>
{% endblock javascripts %}  
